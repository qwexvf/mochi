# üç° mochi - Code First GraphQL for Gleam

[![Package Version](https://img.shields.io/hexpm/v/mochi)](https://hex.pm/packages/mochi)
[![Hex Docs](https://img.shields.io/badge/hex-docs-ffaff3)](https://hexdocs.pm/mochi/)

**mochi** is a type-safe, Code First GraphQL library for Gleam. Define your types in Gleam and automatically generate GraphQL schemas, TypeScript types, and SDL.

Inspired by [gqlkit](https://zenn.dev/izumin/articles/da27a6dfffba0b).

## Features

- **Code First** - Define GraphQL schemas using Gleam types
- **Type Safe** - Full compile-time type checking
- **TypeScript Codegen** - Generate `.d.ts` files from your schema
- **SDL Generation** - Generate `.graphql` schema files
- **Zero Config** - Simple, intuitive API
- **Dual Target** - Works on BEAM (Erlang) and JavaScript

## Installation

```sh
gleam add mochi
```

## Quick Start

```gleam
import mochi/query
import mochi/schema
import mochi/types

// 1. Define your Gleam types
pub type User {
  User(id: String, name: String, email: String, age: Int)
}

// 2. Create GraphQL type with type-safe field extractors
fn user_type() -> schema.ObjectType {
  types.object("User")
  |> types.description("A user in the system")
  |> types.id("id", fn(u: User) { u.id })
  |> types.string("name", fn(u: User) { u.name })
  |> types.string("email", fn(u: User) { u.email })
  |> types.int("age", fn(u: User) { u.age })
  |> types.build(decode_user)
}

// 3. Define queries
fn users_query() {
  query.query(
    "users",
    schema.list_type(schema.named_type("User")),
    fn(_ctx) { Ok(get_users()) },
    fn(users) { types.to_dynamic(users) },
  )
}

fn user_query() {
  query.query_with_args(
    "user",
    [query.arg("id", schema.non_null(schema.id_type()))],
    schema.named_type("User"),
    decode_id_arg,
    fn(id, _ctx) { get_user_by_id(id) },
    types.to_dynamic,
  )
}

// 4. Build the schema
pub fn create_schema() -> schema.Schema {
  query.new()
  |> query.add_query(users_query())
  |> query.add_query(user_query())
  |> query.add_type(user_type())
  |> query.build
}
```

## TypeScript Codegen

Generate TypeScript type definitions from your schema:

```gleam
import mochi/codegen/typescript

let ts_code = typescript.generate(schema)
// Write to: types.generated.ts
```

**Output:**

```typescript
// Generated by mochi

export type Maybe<T> = T | null | undefined;

export type Scalars = {
  ID: string;
  String: string;
  Int: number;
  Float: number;
  Boolean: boolean;
};

export interface User {
  id: Scalars["ID"];
  name?: Maybe<Scalars["String"]>;
  email?: Maybe<Scalars["String"]>;
  age?: Maybe<Scalars["Int"]>;
}

export interface QueryUserArgs {
  id: Scalars["ID"];
}

export interface Query {
  user(args: QueryUserArgs): Maybe<User>;
  users: Maybe<Maybe<User>[]>;
}
```

## SDL Generation

Generate GraphQL SDL from your schema:

```gleam
import mochi/codegen/sdl

let graphql_schema = sdl.generate(schema)
// Write to: schema.graphql
```

**Output:**

```graphql
# Generated by mochi

"A user in the system"
type User {
  id: ID!
  name: String
  email: String
  age: Int
}

type Query {
  "Get a user by ID"
  user(id: ID!): User
  "Get all users"
  users: [User]!
}
```

## API Reference

### Type Builders (`mochi/types`)

```gleam
// Create object type
types.object("User")
|> types.description("A user")
|> types.id("id", fn(u) { u.id })
|> types.string("name", fn(u) { u.name })
|> types.int("age", fn(u) { u.age })
|> types.float("score", fn(u) { u.score })
|> types.bool("active", fn(u) { u.active })
|> types.list_string("tags", fn(u) { u.tags })
|> types.build(decoder)

// Create enum type
types.enum_type("Role")
|> types.value("ADMIN")
|> types.value_with_desc("USER", "Standard user")
|> types.build_enum
```

### Query Builders (`mochi/query`)

```gleam
// Simple query (no args)
query.query("users", return_type, resolver, encoder)

// Query with arguments
query.query_with_args("user", args, return_type, args_decoder, resolver, encoder)

// Mutation
query.mutation("createUser", args, return_type, args_decoder, resolver, encoder)

// Build schema
query.new()
|> query.add_query(users_query)
|> query.add_mutation(create_user_mutation)
|> query.add_type(user_type)
|> query.build
```

### Codegen

```gleam
// TypeScript
import mochi/codegen/typescript
let ts = typescript.generate(schema)
let ts = typescript.generate_with_config(schema, config)

// SDL
import mochi/codegen/sdl
let gql = sdl.generate(schema)
let gql = sdl.generate_with_config(schema, config)
```

## Module Structure

```
mochi/
‚îú‚îÄ‚îÄ query.gleam           # Query/Mutation builders
‚îú‚îÄ‚îÄ types.gleam           # Type builders (object, enum)
‚îú‚îÄ‚îÄ schema.gleam          # Core schema types
‚îú‚îÄ‚îÄ parser.gleam          # GraphQL query parser
‚îú‚îÄ‚îÄ executor.gleam        # Query execution engine
‚îú‚îÄ‚îÄ codegen/
‚îÇ   ‚îú‚îÄ‚îÄ typescript.gleam  # TypeScript generation
‚îÇ   ‚îî‚îÄ‚îÄ sdl.gleam         # SDL generation
‚îî‚îÄ‚îÄ ...
```

## Examples

### Defining Mutations

```gleam
pub type CreateUserInput {
  CreateUserInput(name: String, email: String)
}

fn create_user_mutation() {
  query.mutation(
    "createUser",
    [query.arg("input", schema.non_null(schema.named_type("CreateUserInput")))],
    schema.named_type("User"),
    decode_create_input,
    fn(input, ctx) {
      // Insert into database
      create_user(ctx.db, input)
    },
    types.to_dynamic,
  )
  |> query.mutation_description("Create a new user")
}
```

### Custom Configuration

```gleam
// TypeScript with custom config
let config = typescript.Config(
  use_exports: True,
  use_interfaces: True,
  readonly_properties: True,
  include_helpers: True,
  header: Some("// Custom header"),
)
let ts = typescript.generate_with_config(schema, config)

// SDL with custom config
let config = sdl.Config(
  include_descriptions: True,
  include_builtin_scalars: False,
  indent: "  ",
  header: Some("# My Schema"),
)
let gql = sdl.generate_with_config(schema, config)
```

## Running Tests

```sh
gleam test
```

## Development

```sh
gleam build          # Build the library
gleam test           # Run tests (35 tests)
gleam run            # Run demo
```

## License

Apache 2.0

---

**mochi** üç° - Code First GraphQL for Gleam
# CI trigger
